### 第一步：在 poli_data 库中创建结果表

```sql
-- 1. 切换到新库
USE poli_data;

-- 2. 建表
DROP TABLE IF EXISTS `t_daily_activity_report`;

CREATE TABLE `t_daily_activity_report` (
  `report_date` date NOT NULL COMMENT '报表日期',
  `uid` varchar(32) NOT NULL,
  `sid` int(11) DEFAULT NULL,
  `nickname` varchar(32) DEFAULT NULL,
  `viplv` int(11) DEFAULT NULL,
  `total_recharge_amount` decimal(10,2) DEFAULT NULL,
  `happy_stage_id` int(11) DEFAULT NULL COMMENT '欢乐冒险当前关卡',
  `extreme_stage_id` int(11) DEFAULT NULL COMMENT '极限挑战当前关卡',
  `happy_total_count` int(11) DEFAULT NULL,
  `happy_daily_count` int(11) DEFAULT NULL,
  `extreme_total_count` int(11) DEFAULT NULL,
  `extreme_daily_count` int(11) DEFAULT NULL,
  `extreme_total_mopup` int(11) DEFAULT NULL,
  `extreme_daily_mopup` int(11) DEFAULT NULL,
  `drop_info` text COMMENT '当日掉落',
  `extreme_stage_info` text COMMENT '极限挑战分布',
  `happy_stage_info` text COMMENT '欢乐冒险分布',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`report_date`, `uid`),
  KEY `idx_date` (`report_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 第二步：在 poli_data 库中创建存储过程

```
DELIMITER $$

USE poli_data$$

DROP PROCEDURE IF EXISTS `proc_generate_daily_activity_report`$$

CREATE PROCEDURE `proc_generate_daily_activity_report`(IN p_run_date DATE)
BEGIN
    DECLARE target_date DATE;
    DECLARE source_item_table VARCHAR(100);
    DECLARE target_report_table VARCHAR(100);
    DECLARE create_table_sql LONGTEXT;
    DECLARE insert_data_sql LONGTEXT;

    -- 1. 确定日期
    IF p_run_date IS NULL THEN
        SET target_date = CURDATE();
    ELSE
        SET target_date = p_run_date;
    END IF;

    -- 2. 动态生成表名
    SET source_item_table = CONCAT('db_ro3_operation_log.`item_log_', target_date, '`');
    SET target_report_table = CONCAT('poli_data.`t_report_', DATE_FORMAT(target_date, '%Y%m%d'), '`');

    -- 3. 动态建表 (已删除 created_at 列)
    SET @create_sql = CONCAT('
        CREATE TABLE IF NOT EXISTS ', target_report_table, ' (
          `uid` varchar(32) NOT NULL,
          `sid` int(11) DEFAULT NULL,
          `nickname` varchar(32) DEFAULT NULL,
          `viplv` int(11) DEFAULT NULL,
          `total_recharge_amount` decimal(10,2) DEFAULT NULL,
          `欢乐冒险当前关卡id` int(11) DEFAULT NULL,
          `极限挑战当前关卡id` int(11) DEFAULT NULL,
          `欢乐冒险总挑战次数` int(11) DEFAULT NULL,
          `欢乐冒险当日挑战总次数` int(11) DEFAULT NULL,
          `极限挑战总挑战次数` int(11) DEFAULT NULL,
          `极限挑战当日挑战总次数` int(11) DEFAULT NULL,
          `极限挑战历史总扫荡次数` int(11) DEFAULT NULL,
          `极限挑战当日总扫荡次数` int(11) DEFAULT NULL,
          `当日扫荡掉落物品ID:数量` text,
          `关卡极限挑战挑战次数` text,
          `关卡欢乐冒险挑战次数` text,
          PRIMARY KEY (`uid`)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
    ');

    PREPARE stmt_create FROM @create_sql;
    EXECUTE stmt_create;
    DEALLOCATE PREPARE stmt_create;

    -- 4. 动态插入
    SET @insert_sql = CONCAT('
        INSERT IGNORE INTO ', target_report_table, '
        (
            `uid`, `sid`, `nickname`, `viplv`, `total_recharge_amount`,
            `欢乐冒险当前关卡id`, `极限挑战当前关卡id`, `欢乐冒险总挑战次数`, `欢乐冒险当日挑战总次数`,
            `极限挑战总挑战次数`, `极限挑战当日挑战总次数`, `极限挑战历史总扫荡次数`, `极限挑战当日总扫荡次数`,
            `当日扫荡掉落物品ID:数量`, `关卡极限挑战挑战次数`, `关卡欢乐冒险挑战次数`
        )
        SELECT 
            role.uid,
            role.sid,
            role.nickname,
            role.viplv,
            IFNULL(pay.total_recharge, 0),
            
            MAX(CASE WHEN log.stagetype = 1 THEN log.stageid ELSE 0 END),
            MAX(CASE WHEN log.stagetype = 2 THEN log.stageid ELSE 0 END),
            
            SUM(CASE WHEN log.stagetype = 1 AND log.ismopup = 0 THEN 1 ELSE 0 END),
            SUM(CASE WHEN log.stagetype = 1 AND log.ismopup = 0 AND DATE(log.time_stamp) = ''', target_date, ''' THEN 1 ELSE 0 END),
            
            SUM(CASE WHEN log.stagetype = 2 AND log.ismopup = 0 THEN 1 ELSE 0 END),
            SUM(CASE WHEN log.stagetype = 2 AND log.ismopup = 0 AND DATE(log.time_stamp) = ''', target_date, ''' THEN 1 ELSE 0 END),
            
            SUM(CASE WHEN log.ismopup = 1 THEN 1 ELSE 0 END),
            SUM(CASE WHEN log.ismopup = 1 AND DATE(log.time_stamp) = ''', target_date, ''' THEN 1 ELSE 0 END),
            
            IFNULL(t_drop.drop_info, ''''),
            IFNULL(t_extreme.stage_info, ''''),
            IFNULL(t_happy.stage_info, '''')
        FROM
            db_ro3_operation_log.poli_island_log AS log
        LEFT JOIN db_ro3_operation_log.SNAP_ROLE AS role ON log.uid = role.uid
        LEFT JOIN (
            SELECT uid, SUM(amount) / 100 AS total_recharge
            FROM db_ro3_sdk2.T_ORDER 
            WHERE status = 2
            GROUP BY uid
        ) AS pay ON log.uid = pay.uid
        
        LEFT JOIN (
            SELECT 
                pl.uid, 
                GROUP_CONCAT(CONCAT(il.itemid, '': '', il.num) SEPARATOR '', '') AS drop_info
            FROM db_ro3_operation_log.poli_island_log pl
            INNER JOIN ', source_item_table, ' il ON pl.batchid = il.reason
            WHERE pl.ismopup = 1 AND DATE(pl.time_stamp) = ''', target_date, '''
            GROUP BY pl.uid
        ) AS t_drop ON log.uid = t_drop.uid
        
        LEFT JOIN (
            SELECT uid, GROUP_CONCAT(CONCAT(stageid, '': '', cnt) ORDER BY stageid ASC SEPARATOR '','') AS stage_info
            FROM (
                SELECT uid, stageid, COUNT(*) AS cnt
                FROM db_ro3_operation_log.poli_island_log
                WHERE stagetype = 2 AND ismopup = 0 AND DATE(time_stamp) = ''', target_date, '''
                GROUP BY uid, stageid
            ) sub GROUP BY uid
        ) AS t_extreme ON log.uid = t_extreme.uid
        
        LEFT JOIN (
            SELECT uid, GROUP_CONCAT(CONCAT(stageid, '': '', cnt) ORDER BY stageid ASC SEPARATOR '','') AS stage_info
            FROM (
                SELECT uid, stageid, COUNT(*) AS cnt
                FROM db_ro3_operation_log.poli_island_log
                WHERE stagetype = 1 AND ismopup = 0 AND DATE(time_stamp) = ''', target_date, '''
                GROUP BY uid, stageid
            ) sub GROUP BY uid
        ) AS t_happy ON log.uid = t_happy.uid
        
        GROUP BY log.uid, role.sid, role.nickname, role.viplv, pay.total_recharge
    ');

    PREPARE stmt_insert FROM @insert_sql;
    EXECUTE stmt_insert;
    DEALLOCATE PREPARE stmt_insert;
    
END$$

DELIMITER ;
```

### 第三步：设置定时任务（每天自动跑）

注意参数传 `NULL`，表示“跑当天的”。

```sql
SET GLOBAL event_scheduler = ON;

CREATE EVENT `poli_data`.`evt_daily_activity_report`
ON SCHEDULE EVERY 1 DAY
STARTS '2025-12-06 23:55:00'
DO
    -- 传 NULL，脚本内部会自动取 CURDATE()
    CALL poli_data.proc_generate_daily_activity_report(NULL);
```

### 第四步：手动册测试

```
-- 手动跑 2025-12-05 的数据
CALL poli_data.proc_generate_daily_activity_report('2025-12-05');
```

### 第五步：查看定时任务

```
SELECT * FROM information_schema.EVENTS 
WHERE EVENT_SCHEMA = 'poli_data' 
AND EVENT_NAME = 'evt_daily_activity_report';
```

